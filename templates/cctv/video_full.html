{% extends 'cctv/base.html' %}

{% block title %}{{ t.video_full_title }} - {{ t.app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <p class="eyebrow">{{ t.video_full_subtitle }}</p>
        <h1>{{ t.video_full_title }}</h1>
    </div>
</div>

<!-- Filters -->
<div class="filters">
    <div class="filter-group">
        <label>{{ t.select_region }}</label>
        <select id="regionFilter" onchange="filterBranchesByRegion()">
            <option value="">{{ t.all_regions }}</option>
            {% for region in regions %}
            <option value="{{ region.id }}">{{ region.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>{{ t.select_branch }}</label>
        <select id="branchFilter">
            <option value="">{{ t.all_branches }}</option>
            {% for branch in branches %}
            <option value="{{ branch.id }}" data-region="{{ branch.region.id }}">{{ branch.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>{{ t.date }}</label>
        <input type="date" id="dateFilter">
    </div>
    <button class="btn btn-secondary" onclick="applyFilters()">{{ t.apply_filter }}</button>
</div>

<!-- Video List Table -->
<div class="table">
    <div class="table-head" style="grid-template-columns: 1.5fr 1fr 1fr 0.8fr 0.8fr 0.6fr;">
        <span>{{ t.file_id }}</span>
        <span>{{ t.branch_name }}</span>
        <span>{{ t.camera }}</span>
        <span>{{ t.date }}</span>
        <span>{{ t.duration }}</span>
        <span class="text-right">{{ t.actions }}</span>
    </div>
    <div class="table-body">
        {% for video in videos %}
        <div class="table-row" style="grid-template-columns: 1.5fr 1fr 1fr 0.8fr 0.8fr 0.6fr;">
            <span class="font-mono">{{ video.file_id }}</span>
            <span>{{ video.branch.name }}</span>
            <span>{{ video.camera.name }}</span>
            <span>{{ video.recorded_date|date:"Y-m-d" }}</span>
            <span>{{ video.duration|floatformat:0 }}s</span>
            <span class="text-right">
                <button class="btn btn-sm btn-ghost" onclick="playVideo('{{ video.file_path }}')">▶</button>
            </span>
        </div>
        {% empty %}
        <div class="empty-state">
            <p class="empty-state-text">{{ t.no_videos }}</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination -->
{% if videos %}
<div class="pagination">
    {% if page_obj.has_previous %}
    <button class="page-btn" onclick="goToPage(1)">«</button>
    <button class="page-btn" onclick="goToPage({{ page_obj.previous_page_number }})">‹</button>
    {% endif %}
    
    <button class="page-btn active">{{ page_obj.number }}</button>
    
    {% if page_obj.has_next %}
    <button class="page-btn" onclick="goToPage({{ page_obj.next_page_number }})">›</button>
    <button class="page-btn" onclick="goToPage({{ page_obj.paginator.num_pages }})">»</button>
    {% endif %}
</div>
{% endif %}

<!-- Video Player Modal -->
<div class="modal-backdrop" id="videoModal" style="display: none;">
    <div class="modal" style="width: min(800px, 90%);">
        <div class="modal-header">
            <h2>{{ t.nav_video_full }}</h2>
            <button class="modal-close" onclick="closeVideoModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="modal-video" id="videoContainer">
                <video id="videoPlayer" controls style="width:100%;height:100%;">
                    <source src="" type="video/mp4">
                </video>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function filterBranchesByRegion() {
        const regionId = document.getElementById('regionFilter').value;
        const branchSelect = document.getElementById('branchFilter');
        const options = branchSelect.querySelectorAll('option');
        
        // Reset branch selection
        branchSelect.value = '';
        
        options.forEach(option => {
            if (option.value === '') {
                // Keep "All Branches" visible
                option.style.display = 'block';
                option.hidden = false;
            } else {
                const optionRegion = option.dataset.region;
                if (!regionId || optionRegion === regionId) {
                    option.style.display = 'block';
                    option.hidden = false;
                } else {
                    option.style.display = 'none';
                    option.hidden = true;
                }
            }
        });
    }
    
    function applyFilters() {
        const region = document.getElementById('regionFilter').value;
        const branch = document.getElementById('branchFilter').value;
        const date = document.getElementById('dateFilter').value;
        
        let params = new URLSearchParams();
        if (region) params.append('region', region);
        if (branch) params.append('branch', branch);
        if (date) params.append('date', date);
        
        window.location.href = `{% url 'cctv:video_full' %}?${params.toString()}`;
    }
    
    function goToPage(page) {
        const url = new URL(window.location);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }
    
    function playVideo(path) {
        const modal = document.getElementById('videoModal');
        const player = document.getElementById('videoPlayer');
        player.src = path;
        modal.style.display = 'flex';
        player.play();
    }
    
    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        const player = document.getElementById('videoPlayer');
        player.pause();
        player.src = '';
        modal.style.display = 'none';
    }
</script>
{% endblock %}
