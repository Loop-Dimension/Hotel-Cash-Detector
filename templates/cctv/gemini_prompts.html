{% extends 'cctv/base.html' %}
{% load static %}

{% block title %}Gemini AI Prompts - {{ t.app_name }}{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .prompt-section {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .prompt-section h3 {
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .prompt-section .icon {
        font-size: 24px;
    }
    
    .prompt-textarea {
        width: 100%;
        min-height: 400px;
        padding: 16px;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: vertical;
        background: #1e1e2e;
        color: #cdd6f4;
    }
    
    .prompt-textarea:focus {
        outline: none;
        border-color: var(--blue-500);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .btn-group {
        display: flex;
        gap: 12px;
    }
    
    .info-banner {
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .info-banner p {
        margin: 0;
        color: var(--blue-700);
    }
    
    .prompt-label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 18px;
    }
    
    .prompt-desc {
        color: var(--text-secondary);
        font-size: 13px;
        margin-top: 4px;
    }
    
    .event-badges {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .event-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .event-badge.cash {
        background: #fef3c7;
        color: #92400e;
    }
    
    .event-badge.violence {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .event-badge.fire {
        background: #ffedd5;
        color: #9a3412;
    }
    
    .tips-section {
        background: var(--gray-50);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    
    .tips-section h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--text-primary);
    }
    
    .tips-section ul {
        margin: 0;
        padding-left: 20px;
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    .tips-section li {
        margin-bottom: 6px;
    }
    
    .tips-section code {
        background: var(--gray-200);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <h1>ü§ñ Gemini AI Prompts</h1>
        <p class="text-muted">Configure the unified AI validation prompt for all detection types</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-secondary" onclick="resetPrompt()">‚Üª Reset to Default</button>
        <button class="btn btn-primary" onclick="savePrompt()">üíæ Save Prompt</button>
    </div>
</div>

<div class="page-container">
    <div class="info-banner">
        <p>üí° This unified prompt is used by Gemini AI to validate ALL detected events (Cash, Violence, Fire). The AI receives the event type along with the image and uses this prompt to analyze and validate the detection.</p>
    </div>
    
    <!-- Unified Prompt -->
    <div class="prompt-section">
        <div class="prompt-header">
            <div>
                <div class="prompt-label">üéØ Unified Detection Prompt</div>
                <div class="prompt-desc">This prompt validates all event types - the system passes the event type to analyze</div>
                <div class="event-badges">
                    <span class="event-badge cash">üíµ Cash Transactions</span>
                    <span class="event-badge violence">‚ö†Ô∏è Violence Detection</span>
                    <span class="event-badge fire">üî• Fire/Smoke Detection</span>
                </div>
            </div>
        </div>
        <textarea id="unifiedPrompt" class="prompt-textarea" placeholder="Loading..."></textarea>
        
        <div class="tips-section">
            <h4>üí° Prompt Tips:</h4>
            <ul>
                <li>The <code>{event_type}</code> placeholder will be replaced with: cash, violence, or fire</li>
                <li>Keep the JSON response format for the system to parse results correctly</li>
                <li>Be specific about what constitutes a valid detection for each event type</li>
                <li>Include "DO NOT flag" sections to reduce false positives</li>
            </ul>
        </div>
    </div>
</div>

<script>
    let defaultPrompt = '';
    
    async function loadPrompt() {
        try {
            const response = await fetch('/api/gemini/global-prompts/');
            const data = await response.json();
            
            defaultPrompt = data.defaults.unified || '';
            document.getElementById('unifiedPrompt').value = data.prompts.unified || defaultPrompt;
        } catch (error) {
            console.error('Failed to load prompt:', error);
            alert('Failed to load prompt');
        }
    }
    
    function resetPrompt() {
        if (!confirm('Reset prompt to default?')) return;
        document.getElementById('unifiedPrompt').value = defaultPrompt;
    }
    
    async function savePrompt() {
        try {
            const response = await fetch('/api/gemini/global-prompts/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    unified: document.getElementById('unifiedPrompt').value
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                alert('Prompt saved successfully! ' + (data.message || ''));
            } else {
                alert('Failed to save prompt');
            }
        } catch (error) {
            console.error('Failed to save prompt:', error);
            alert('Failed to save prompt');
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Load prompt on page load
    document.addEventListener('DOMContentLoaded', loadPrompt);
</script>
{% endblock %}
